<div id="analysis_default_form" class="spreadsheet_popup" style="display:none" chosen_test="mytest"
     xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
  <div class="spreadsheet_box_title">
    <div style="float: left">Analysis Input and Parameters</div>
    <div style="float: right"><a href="#" onclick="cleanup_menu(); return false;">Close</a></div>
    <br style="clear:both"/>
  </div>
  <!--<div id="ipython_figure"></div>-->
  <p>
    Chosen Analysis: <b id="test_name"></b>
  </p>
  <%= form_tag_with_callbacks({:action => :pythonize},
                              {:method=>:post,
                               #:action=>"javascript:alert('in form action')", #send_to_python('ttest')",
                               :loading => "$j('analysis_button').disabled=true;",
                               :complete => "cleanup_menu();$j('analysis_button').disabled=false;",
                               :id => "analysis_default_form",:remote => true}) do %>

    <p>
      Cell Range:<br/>
      <%= text_field_tag :analysis_selection_data, nil,:class=>"annotation_cell_coverage_class" %>
    </p>

<!--
    <p>
      Some text:<br/>
      < %= text_field_tag :some_text, nil %>
    </p>
-->
    <%= render :partial => "spreadsheet_analysis/ttest" %>
    <%= submit_tag 'Run',:id=>"analysis_button", :onclick => "return send_to_jupyter();" %>
  <% end %>
</div>

<script type="text/javascript">
    function send_to_jupyter() {
        console.log("test: ", $j("div#analysis_default_form").attr("chosen_test"));
        console.log("popmean: ", $j("input#analysis_popmean").val());
        var analysis_params = {}
        $j("input[name^=analysis]").each(function () {
            analysis_params[$(this).name] =$(this).value
        });
        console.log(analysis_params);
        send_to_python($j("div#analysis_default_form").attr("chosen_test"), analysis_params);
    }

    //update form changes on selected cell ranges in the spreadsheet
    function apply_form_changes() {
        select_typed_input($j('input#analysis_selection_data').val());
    }

    //hide form and sub-form
    function cleanup_menu() {
        // the test form to delete should be the last word in the "chosen_test" attribute, e.g. 'paired_ttest' --> 'ttest'
        var form_name = $j("div#analysis_default_form").attr("chosen_test").split("_").slice(-1)[0]
        console.log("cleanup menu: ", form_name )

        $j("div#"+form_name+"_form").hide();
        $j('#analysis_default_form').hide();
        reset_values();
    }

    $j(document).ready(function () {

        //prevent immediate submission on input changes when pressing 'Enter'
        //if there are other input fields, apply changes and move to the next field. If on Enter on 'Submit', submit the form.
        var inputs = $j('form#analysis_default_form input')
        console.log(inputs);
        $j('form#analysis_default_form input:not([type="submit"])')
            .keydown(function (e) {
                if (e.keyCode == 13) {
                    e.preventDefault();
                    if (inputs[inputs.index(this) + 1] != null) {
                        inputs[inputs.index(this) + 1].focus();
                    }
                    apply_form_changes();         //applies input changes no matter where we are
                    return false;
                }
            });

        //      $j('#analysis_button').click(function() {
        //          test = $j("div#analysis_default_form").attr("chosen_test")
        //          console.log(test)
        //      });
    });

</script>
